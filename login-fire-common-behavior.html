<!--
@license
Copyright (c) 2016 Convoo All Rights Reserved.
Use of this source code is governed by a MIT license that can be found in the
LICENSE file or at https://github.com/convoo/login-fire/blob/master/LICENSE.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="./locales.html">
<script>
(function() {
  'use strict';

  window.Convoo = window.Convoo || {};

  /**
   * Federated identity providers available for Firebase Authentication.
   */
  Convoo._firebaseProviders = {
    anonymous: {
      id: 'anonymous',
      isSocialNetwork: false,
      name: 'Anonymous'
    },
    facebook: {
      id: 'facebook',
      isSocialNetwork: true,
      name: 'Facebook',
      scopes: ''
    },
    github: {
      id: 'github',
      isSocialNetwork: true,
      name: 'Github',
      scopes: ''
    },
    google: {
      id: 'google',
      isSocialNetwork: true,
      name: 'Google',
      scopes: ''
    },
    email: {
      id: 'email',
      isSocialNetwork: false,
      name: 'Email'
    },
    twitter: {
      id: 'twitter',
      isSocialNetwork: true,
      name: 'Twitter',
      scopes: ''
    }
  };

  /**
   * A behavior that allows an element using Firebase Auth to sign-in a user.
   *
   * If you want your element to authenticate a user with a federated identity
   * provider _(Google, Facebook, Twitter, GitHub)_, it has to implement the
   * `LoginFireSocialBehavior` behavior and use one of these providers:
   *
   * - anonymous (for signin anonymously)
   * - facebook
   * - github
   * - google
   * - twitter
   *
   * If you want your element to authenticate a user by email address and password,
   * it has to implement the `LoginFireFormBehavior` behavior and use the provider
   * 'email'.
   *
   * @polymerBehavior Convoo.LoginFireCommonBehavior
   */
  Convoo.LoginFireCommonBehaviorImpl = {
    properties: {
      /**
       * An application name. This is required if you want use several Firebase
       * configurations in the same app. All elements that implement this
       * behavior and having the same application name share their properties.
       *
       * @type {String}
       */
      appName: {
        type: String,
        value: ''
      },

      /**
       * Aggregate object with debug information including Firebase app name,
       * provider and whether to redirect.
       *
       * @type {Object}
       */
      config: {
        type: Object,
        readOnly: true,
        computed: '_computeConfig(appName, provider, redirect)'
      },

      /**
       * Sets the element in debug mode. In the debug mode, the Firebase
       * configuration used by the element and relevant steps like a user
       * change are print out into the browser's console.
       *
       * @type {Boolean}
       */
      debug: {
        type: Boolean,
        value: false
      },

      /**
       * Flat button, yes or not.
       *
       * @type {Boolean}
       */
      flat: {
        type: Boolean,
        value: false
      },

      /**
       * Sets the language to use.
       *
       * @type {String}
       */
      language: {
        type: String,
        value: 'en'
      },

      /**
       * ID of the federated identity provider to use. The list of available
       * providers is located at `Convoo._firebaseProviders`.
       *
       * @type {String}
       */
      provider: {
        type: String,
        value: 'anonymous'
      },

      /**
       * Defines if the authentication must use redirection. If `false`, the
       * authentication will use pop-up.
       *
       * @type {Boolean}
       */
      redirect: {
        type: Boolean,
        value: false
      },

      /**
       * `True` if a user is authenticated, otherwise `false`.
       *
       * @type {Boolean}
       */
      signedIn: {
        type: Boolean,
        value: false,
        readOnly: true,
        notify: true
      },

      /**
       * Whether to show the view at sign up or sign in.
       *
       * @type {Boolean}
       */
      showSignUp: {
        type: Boolean,
        value: false,
        notify: true
      },

      /**
       * When `true`, login status can be determined by checking user property.
       *
       * @type {Boolean}
       */
      statusKnown: {
        type: Boolean,
        value: false,
        readOnly: true,
        notify: true
      },

      /**
       * Signed-in user. This user representation is accessible from all elements
       * that use Firebase Auth with the same application name.
       *
       * @type {Object}
       */
      user: {
        type: Object,
        readOnly: true,
        notify: true
      },

      /**
       * Automatically sign in the user with credentials stored in
       * Credentials API
       *
       * @type {Boolean}
       */
      auto: {
        type: Boolean,
        value: true
      },

      /**
       * Prevents the element from signing out. It means, if this attribute is
       * `true`, the `signOut` method has no effect.
       *
       * @type {Boolean}
       */
      noSignOut: {
        type: Boolean,
        value: false
      },

      /**
       * Prevents the element from signing in. It means, if this attribute is
       * `true`, the `signIn` method has no effect.
       *
       * @type {Boolean}
       */
      noSignIn: {
        type: Boolean,
        value: false
      },

      /**
       * Path to an external file containing locales. If the value is set, the
       * target file will be used instead of the default one _("locales.html")_.
       *
       * The target file must be in JSON format. Be sure the file is kept
       * during the build of your project. By default, the Polymer build pipe
       * loses JSON files during the optimization.
       *
       * For more detail about the file format, please read the
       * <a href="https://github.com/PolymerElements/app-localize-behavior">AppLocalizeBehavior</a>
       * documentation.
       *
       * @type {String}
       */
      localesFile: {
        type: String
      },

      /**
       * `True` if a user is authenticated, otherwise `false`.
       *
       * @type {Boolean}
       */
      _signedIn: {
        type: Boolean,
        observer: '_signedInChanged'
      },

      /**
       * When `true`, login status can be determined by checking user property.
       *
       * @type {Object}
       */
      _statusKnown: {
        type: Boolean,
        observer: '_statusKnownChanged'
      },

      /**
       * Signed-in user (private). It is accessible from all elements that use
       * Firebase Auth with the same application name through the property
       * `user`.
       *
       * @type {Object}
       */
      _user: {
        type: Object,
        observer: '_userChanged'
      },

      /**
       * This property is used in `login-fire` and `login-fire-social` when the
       * user is signed in and allowed to sign out. Then it shows only one
       * button (instead of multiple) to sign out.
       */
      _showOneButton: {
        type: Boolean,
        computed: '_computeShowOneButton(noSignIn, signedIn, noSignOut)'
      },

      /**
       * Indicates if a sign in or sign out process is currently in progress.
       *
       * @type {Boolean}
       * @default false
       */
      inProgress: {
        type: Boolean,
        value: false,
        readOnly: true,
        notify: true
      }
    },

    attached: function() {
      if (this.localesFile && typeof this.localesFile !== 'undefined') {
        this.loadResources(this.resolveUrl(this.localesFile));
      } else {
        this.set('resources', window.Convoo._locales);
      }
    },

    ready: function() {
      if (this.debug) {
        console.debug('### Debug Mode Enabled ###');
        console.debug('Initial configuration:', this.config);
      }
    },

    /**
     * Starts the sign-out process.
     */
    signOut: function() {
      // Skip processing of this method when we already have started a sign or signout process
      if (this.inProgress) {
        if (this.debug) {
          console.debug('Ignored signOut when already in progress');
        }
        return;
      }

      if (this.debug) {
        console.debug('The element ' + this.is + (this.noSignOut ? ' cannot' : ' can') + ' sign out.');
      }

      if (!this.noSignOut && this.signedIn) {
        // Set inProgress flag to true when a signout is started
        this._setInProgress(true);
        this.$.auth.signOut().then(this._fireEvent.bind(this));
      }

      // Ensure the auto sign-in wonâ€™t happen until next time the user enables auto sign-in
      if (navigator.credentials) {
        navigator.credentials.preventSilentAccess();
      }
    },

    /**
     * Computes the element configuration.
     *
     * @param  {String}  appName  the application name
     * @param  {String}  provider id
     * @param  {Boolean} redirect
     * @return {Object}           the element configuration.
     */
    _computeConfig: function(appName, provider, redirect) {
      return {
        appName: appName,
        provider: Convoo._firebaseProviders[provider],
        redirect: redirect,
        debug: this.debug
      };
    },

    /**
     * Returns `true` when the element allows only to signing out or a user is
     * already signed in and they can signing out.
     */
    _computeShowOneButton: function(noSignIn, signedIn, noSignOut) {
      return noSignIn || (signedIn && !noSignOut);
    },

    /**
     * Fires the Firebase errors.
     *
     * @param  {Object} error get from Firebase Auth API
     */
    _fireError: function(error) {
      if (this.debug) {
        console.debug('Firing error');
        console.debug(error);
      }
      this.fire('error', error);
      // When an error event was fired, we have to set the inProgress flag back to false
      this._setInProgress(false);
    },

    /**
     * Fires an event for signaling the user is signed-in or signed-out.
     *
     * @param  {Object} response from Firebase Auth
     */
    _fireEvent: function(response) {
      if (this.debug) {
        console.debug('Firing event');
      }
      if (response) {
        var user = response.user || response;
        var credential = response.credential;
        this.fire('signedin', {
          user: user,
          credential: credential
        });
        if (this.debug) {
          console.debug('User signed in with', this.config.provider.name);
          console.debug({
            user: user,
            credential: credential
          });
        }
      } else {
        this.fire('signedout');
        if (this.debug) {
          console.debug('User signed out from', this.config.provider.name);
        }
      }
      // When signin or signout event was fired, we have to set the inProgress flag back to false
      this._setInProgress(false);
    },

    /**
     * Updates the readOnly value of signedIn.
     *
     * @param  {Boolean} newVal
     * @param  {Boolean} oldVal
     */
    _signedInChanged: function(newVal, oldVal) {
      if (this.debug && typeof oldVal !== 'undefined') {
        console.debug('SignedIn changed for', newVal);
      }
      this._setSignedIn(newVal);
    },

    /**
     * Updates the readOnly value of statusKnown.
     *
     * @param  {Boolean} newVal
     * @param  {Boolean} oldVal
     */
    _statusKnownChanged: function(newVal, oldVal) {
      if (this.debug && typeof oldVal !== 'undefined') {
        console.debug('StatusKnown changed for', newVal);
      }
      this._setStatusKnown(newVal);

      if(newVal) {
        this._retrieveCredentialFromCredentialAPI().then((cred) => {
          if (this.debug) {
            console.debug(`Credential found: ${cred}`);
          }
          this.signIn(cred.id, cred.password);
        }).catch((err) => {
          if (this.debug) {
            console.debug(err);
          }
        });
      }
    },

    /**
    * Retrieve credentials from Credential API (browser)
    *
    * @return {Object} a promise that resolves with the id/password stored in the browser
    */
    _retrieveCredentialFromCredentialAPI: function() {
      return new Promise((resolve, reject) => {
        
        if (!(navigator.credentials && navigator.credentials.preventSilentAccess && this.auto)) {
          return reject('Credential API: unavailable with this browser');
        }

        // User already signedIn, no need to retrieve credentials
        if (this.signedIn) {
          return reject('Credential API: User is already signedIn');
        }

        // The new Credential Management API is available
        if (this.debug) {
          console.debug('Credential API: available, calling...');
        }

        navigator.credentials.get({
          password: true
        }).then((cred) => {

          // Ensure they're not empty 
          if (!cred) {
            return reject('Credential API: cred not found');
          }

          // Ensure user is not already signedIn while fetching credentials
          if (this.signedIn) {
            return reject('Credential API: User is already signedIn after fetch');
          }

          if (cred.type === 'password') {
            return resolve({
              id: cred.id,
              password: cred.password
            });
          }
        }, () => {
          return reject('Credential API: cred not found');
        });
      });
    },

    /**
    * Creates and store a new credential. A new credential is created using the given ID and password.
    * Then, this credential is stored into the navigator credentials store.
    *
    * @param  {String} id the ID of the credential to be created
    * @param  {String} password the password to be set to the credential for the given ID
    * @return {Object} a promise that resolves when the browser has stored the id/password (or immediately if the Credentials API is not supported)
    */
    _storeCredentialsPassword: function (id, password) {
      if (navigator.credentials) {
        var cred = new PasswordCredential({
          id: id,
          password: password
        });
        if(this.debug) {
          console.debug(`Calling Credentials API to store credentials with id : ${id}`);
        }
        return navigator.credentials.store(cred);
      } else {
        console.debug('Credentials API is not available to store credentials...');
        return Promise.resolve();
      }
    },

    /**
     * Toggles signUp property
     */
    _toggleShowSignUp: function() {
      this.showSignUp = !this.showSignUp;
    },

    /**
     * Updates the readOnly value of user.
     *
     * @param  {Object} newVal is the signed-in user
     * @param  {Object} oldVal is the previous signed-in user
     */
    _userChanged: function(newVal, oldVal) {
      if (this.debug && typeof oldVal !== 'undefined') {
        console.debug('User changed for', newVal);
      }
      this._setUser(newVal);
    }

    /**
     * Fired when Firebase returns an error.
     *
     * @event error
     * @param  {Object} error returned by Firebase Auth API.
     */

    /**
     * Fired when a `user` just signed-in.
     *
     * @event signedin
     * @param {Object} user signed-in.
     */

    /**
     * Fired when the `user` signed-out.
     *
     * @event signedout
     */
  };

  /**
   * @polymerBehavior
   */
  Convoo.LoginFireCommonBehavior = [
    Polymer.AppLocalizeBehavior,
    Convoo.LoginFireCommonBehaviorImpl
  ];
}());
</script>
