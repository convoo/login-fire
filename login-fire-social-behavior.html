<!--
@license
Copyright (c) 2016 Convoo All Rights Reserved.
Use of this source code is governed by a MIT license that can be found in the
LICENSE file or at https://github.com/convoo/login-fire/blob/master/LICENSE.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./login-fire-common-behavior.html">
<script>
(function() {
  'use strict';

  window.Convoo = window.Convoo || {};

  /**
   * Behaviour that allows an element using Firebase Auth to sign-in, sign-up
   * and sign-out with social provider authentication. If your element must be
   * able to use email address and password authentication only, you can
   * implement the `LoginFireFormBehavior`.
   *
   * @polymerBehavior Convoo.LoginFireSocialBehavior
   */
  Convoo.LoginFireSocialBehaviorImpl = {

    properties: {
      /**
       * The scopes that you want to access.
       *
       * Available scopes:
       * Facebook -> https://developers.facebook.com/docs/facebook-login/permissions
       * GitHub -> https://developer.github.com/v3/oauth/#scopes
       * Google -> https://developers.google.com/identity/protocols/googlescopes
       */
      scopes: {
        type: String,
        value: ''
      },

      /**
       * OAuth provider instance provided by Firebase. It uses the defined
       * `scopes`.
       *
       * @type {Object}
       */
      _oauthProvider: {
        type: Object,
        computed: '_computeOAuthProvider(provider, scopes)'
      }
    },

    /**
     * Starts the sign-in process using a social provider authetication.
     */
    signIn: function() {
      if (!this.noSignIn) {
        if (this.debug) {
          console.log('Signing in...');
        }
        if (this.provider === 'anonymous') {
          this.$.auth.signInAnonymously()
            .then(this._fireEvent.bind(this))
            .catch(this._fireError.bind(this));
        } else if (this.redirect) {
          this.$.auth.signInWithRedirect(this._oauthProvider)
            .then(this._fireEvent.bind(this))
            // .then((response) => this.storeCredentials(response))
            .catch(this._fireError.bind(this));
        } else {
          this.$.auth.signInWithPopup(this._oauthProvider)
            .then(this._fireEvent.bind(this))
            // .then((response) => this.storeCredentials(response))
            .catch(this._fireError.bind(this));
        }
      }
    },

    /**
     * Starts sign in or sign out a user. If there is currently a user logged
     * in the `signOut` method is called. If there is no user logged in, the
     * `signIn` method is called.
     */
    signInOrOut: function() {
      if (typeof this.user === 'undefined' || this.user == null) {
        this.signIn();
      } else {
        this.signOut();
      }
    },

    /**
     * Store Crendtials in Credentials API
     */
    storeCredentials: function(response) {
      if (navigator.credentials) {

        var providerUrl;
        switch (response.credential.providerId) {
          case 'google.com':
            providerUrl = 'https://accounts.google.com';
            break;
          case 'facebook.com':
            providerUrl = 'https://www.facebook.com';
            break;
        }

        if(this.debug) {
          console.log('Storing credentials in Credentials API');
          console.log(providerUrl);
        }

        var cred = new FederatedCredential({
          id:       response.user.email,                    // id in IdP
          provider: providerUrl,                            // A string representing IdP
          name:     response.user.displayName,              // name in IdP
          iconURL:   response.user.photoURL                  // Profile image url
        });
        return navigator.credentials.store(cred);
      } else {
        return Promise.resolve();
      }
    },

    /**
     * Creates a new OAuth provider according to the given provider's ID.
     *
     * @param  {String} providerId of social network
     * @param  {String} scopes     to be set
     * @return {Object}            OAuth's provider of the chosen social
     * network.
     */
    _computeOAuthProvider: function(providerId, scopes) {
      var provider = Convoo._firebaseProviders[providerId.toLowerCase()];
      var oauthProvider;
      if (provider.isSocialNetwork) {
        oauthProvider = new firebase.auth[provider.name + 'AuthProvider']();
        if (provider.scopes) {
          oauthProvider.addScope(provider.scopes);
        }
      }
      return oauthProvider;
    }
  };

  /**
   * @polymerBehavior
   */
  Convoo.LoginFireSocialBehavior = [
    Convoo.LoginFireCommonBehavior,
    Convoo.LoginFireSocialBehaviorImpl
  ];

})();
</script>
