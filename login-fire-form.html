<!--
@license
Copyright (c) 2016 Convoo All Rights Reserved.
Use of this source code is governed by a MIT license that can be found in the
LICENSE file or at https://github.com/convoo/login-fire/blob/master/LICENSE.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="./login-fire-form-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">

<!--
An element that allows simple configuration of email and password authentication with Firebase.

Example:
```
<firebase-app
  name="myApp"
  api-key="API_KEY"
  auth-domain="AUTH_DOMAIN"
  database-url="DATABASE_URL">
</firebase-app>
<login-fire-form app-name="myApp"></login-fire-form>
```

### Styling

Style the buttons with CSS as you would a normal DOM element. 

The following custom properties and mixins are available for styling:

| Custom property | Description | Default |
| --- | --- | --- |
| `--login-fire-reset-password-color` | The color of reset password text | `gray` |
| `--login-fire-reset-password-hover-color` | The color of reset password text when hovered | `gray` |
| `--login-fire-error-msg-color` | The color for the error message  | `--error-color` |
| `--login-fire-info-msg-color` | The color for the info message | `gray` |
| `--login-fire-divider-color` | The color for the divider bar | `gray` |
| `--login-fire-background-color` | The color for the divider bar | `white` |
| `--login-fire-btn-signup` | Mixin applied to the signup button | `{}` |
| `--login-fire-btn-signin` | Mixin applied to the signin button | `{}` |
| `--login-fire-btn-signout` | Mixin applied to the signin button | `{}` |


@demo demo/login-fire-form.html
-->
<dom-module id="login-fire-form">
  <template>
    <style>
    :host {
      display: block;
      @apply(--login-fire-form);
    }
     paper-button.btn--signup {
         margin: 15px 0;
        @apply(--login-fire-btn-signup);
    }
     paper-button.btn--signin {
        @apply(--login-fire-btn-signin);
    }
    .btn{
        color: gray;
    }
    .link--reset-pw {
      color: var(--login-fire-reset-password-color, gray);
      text-decoration: none;
      font-size: 12px;
      font-style: italic;
      font-weight: lighter;
      cursor: pointer;
    }
    .link--reset-pw:hover{
      color: var(--login-fire-reset-password-hover-color, gray);
      text-decoration: underline;
    }
    .msg {
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      line-height: 24px;
      margin: 0;
      padding: 0;
    }
    .msg--error {
      color: var(--login-fire-error-msg-color, --error-color);
    }
    .msg--info {
      color: var(--login-fire-info-msg-color, gray);
    }
    form {
      min-width: 200px;
      margin: 0 auto;
    }
    .action {
        text-align: center;
    }
    .action paper-button {
        width: 100%;
    }
    .signup-toggle {
        font-size: 12px;
        color:grey;
        text-align: center;
        @apply(--login-fire-form-toggle);
    }
    .signup-toggle a {
        text-decoration: underline;
        cursor: pointer;
    }
    </style>

    <div>
      <div class="msg msg--error" hidden$="[[!_lastError]]">
        <span>[[_lastError]]</span>
      </div>
      <div class="msg msg--info" hidden$="[[!_lastMessage]]">
        <span>[[_lastMessage]]</span>
      </div>
    </div>

    <form>
        <template is="dom-if" if="[[!showResetPW]]">
            <paper-input id="emailInput"
                type="email"
                label="Email"
                value="{{email}}"
                error-message="Invalid email address"
                required>
            </paper-input>
            <paper-input id="passwordInput"
                type="password"
                label="Password"
                value="{{password}}"
                required>
            </paper-input>
            <template is="dom-if" if="[[showSignUp]]">
                <paper-input id="repeatPasswordInput"
                    type="password"
                    label="Re-enter Password"
                    value="{{passwordAgain}}"
                    error-message="Passwords do not match"
                    required>
                </paper-input>

                <div class="action">
                    <paper-button raised$="[[!flat]]" type="submit" on-tap="_signUp" class="btn--signup">Sign Up</paper-button>
                </div>
                <p class="signup-toggle">
                    Already have an account? <a on-tap="_toggleShowSignUp">Sign in</a>
                </p>
            </template>
            <template is="dom-if" if="[[!showSignUp]]">
                <p>
                    <a class="link--reset-pw" on-click="toggleShowResetPW">
                    Reset password
                    </a>
                </p>
                <div class="action">
                    <paper-button raised$="[[!flat]]" type="submit" on-tap="_signIn" class="btn--signin">Sign In</paper-button>
                </div>
                <p class="signup-toggle">
                    Don't have an account? <a on-tap="_toggleShowSignUp">Sign up</a>
                </p>
            </template>
        </template>
        <template is="dom-if" if="[[showResetPW]]">
            <paper-input id="resetEmailInput"
                type="email"
                label="Email"
                value="{{email}}"
                error-message="Invalid email address"
                required>
            </paper-input>
            <paper-button raised$="[[!flat]]" type="submit" on-tap="_resetPassword" class="btn--resetpw">Reset Password</paper-button>
            <p>
                <a class="link--reset-pw" on-click="toggleShowResetPW">
                Nevermind, I remembered my password.
                </a>
            </p>
        </template>
    </form>

    <firebase-auth id="auth"
      app-name="[[appName]]"
      user="{{_user}}"
      signed-in="{{_signedIn}}"
      status-known="{{_statusKnown}}">
    </firebase-auth>
  </template>

  <script>
  Polymer({
    is: 'login-fire-form',
    behaviors: [Convoo.LoginFireFormBehavior],

    properties: {
      /**
       * If true, will sign up a user who attempts to sign in with an account
       * that doesn't already exist.
       *
       * @type {Boolean}
       */
      autoSignUp: {
        type: Boolean,
        value: false
      },

      /**
       * Message displayed when the user ask for resetting its password.
       *
       * @type {String}
       */
      passwordResetMessage: {
        type: String,
        value: 'Password reset email has been sent. Please check your inbox.'
      },

      /**
       * Provider ID to use for Firebase Auth.
       *
       * @type {String}
       */
      provider: {
        type: String,
        readOnly: true,
        notify: false,
        value: 'password'
      },

      /**
       * Last error message.
       *
       * @type {String}
       */
      _lastError: {
        type: String
      },

      /**
       * Last message info.
       *
       * @type {String}
       */
      _lastMessage: {
        type: String
      }
    },

    listeners: {
      'error': '_handleError'
    },

    /**
     * Cleans message and error sections.
     */
    _cleanMessages: function() {
      this.set('_lastError', '');
      this.set('_lastMessage', '');
    },

    /**
     * Tries to sign in a user using the form values.
     */
    _signIn: function() {
      this._cleanMessages();
      this.signIn(this.email, this.password);
    },

    /**
     * Tries to sign-up a user using the form values.
     */
    _signUp: function(e) {
        this._cleanMessages();
        this.$$("#repeatPasswordInput").invalid=false;
        e = this.$.emailInput.validate()
        p = this.$.passwordInput.validate()
        pRepeat = this.password == this.passwordAgain
        if (e && p && pRepeat) {
            this.signUp(this.email, this.password);
            this.email = null;
            this.password = null;
            this.passwordAgain = null;
        }else if(!pRepeat){
            this.$$("#repeatPasswordInput").invalid=true;
        }
    },

    /**
     * Displays error message. If the attribute `autoSignUp` is true, before
     * to display the error message, a sign-up process is tried.
     *
     * @param  {Object} e the event caught that contains the error message
     */
    _handleError: function(e) {
      if (this.autoSignUp && e.detail.code === 'auth/user-not-found') {
        this.signUp(this.email, this.password);
        this.email = null;
        this.password = null;
      } else {
        this.set('_lastError', e.detail.message);
      }
    },

    /**
     * Sends an email for resetting the account password. The email is sent to
     * the address entered in the form when the user clicks on the link to reset
     * its password.
     */
    _resetPassword: function() {
      this._cleanMessages();
      e = this.$$("#resetEmailInput").validate() 

      if (e){
        this.$$("#auth").auth.sendPasswordResetEmail(this.email).then(function() {
            this.set('_lastMessage', this.passwordResetMessage);
        }.bind(this), function (error) {
            this.set('_lastError', error.message);
        }.bind(this));
      }
    }
  });
  </script>
</dom-module>
